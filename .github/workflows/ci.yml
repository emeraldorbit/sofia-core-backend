name: Sofia Core CI

on:
  pull_request:
    paths:
      - 'src/**'
      - 'supabase/sofia_core/**'
      - 'tests/**'
      - 'tsconfig.json'
      - 'deno.json'
  push:
    branches:
      - main
      - feature/bridge-triad
      - feature/final-modulation-triad
      - feature/orchestration-synthesis-triad
      - feature/semantic-modulation-triad

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Validate directory structure
        run: |
          echo "Validating Sofia Core Application Shell structure..."
          
          # Check required directories exist
          test -d supabase/sofia_core/sofia_core_application_shell || exit 1
          test -d supabase/sofia_core/deviation_engine || exit 1
          test -d supabase/sofia_core/identity_filter || exit 1
          test -d supabase/sofia_core/membrane_engine || exit 1
          test -d supabase/sofia_core/tonal_engine || exit 1
          test -d supabase/sofia_core/sofia_api || exit 1
          test -d supabase/sofia_core/continuum_modulator || exit 1
          test -d supabase/sofia_core/signature_bridge || exit 1
          test -d supabase/sofia_core/orchestration_engine || exit 1
          test -d supabase/sofia_core/semantic_bridge || exit 1
          test -d supabase/sofia_core/signature_synthesizer || exit 1
          test -d supabase/sofia_core/semantic_modulator || exit 1
          test -d supabase/sofia_core/signature_router || exit 1
          test -d supabase/sofia_core/identity_synthesizer || exit 1
          test -d supabase/sofia_core/field_choice || exit 1
          test -d supabase/sofia_core/field_resolution || exit 1
          test -d supabase/sofia_core/field_commitment || exit 1
          test -d supabase/sofia_core/field_execution || exit 1
          test -d supabase/sofia_core/field_projection || exit 1
          test -d supabase/sofia_core/field_feedback || exit 1
          test -d supabase/sofia_core/field_synthesis || exit 1
          test -d supabase/sofia_core/field_harmonization || exit 1
          test -d supabase/sofia_core/field_stability || exit 1
          
          # Check required files exist
          test -f supabase/sofia_core/sofia_core_application_shell/app_shell_runtime.ts || exit 1
          test -f supabase/sofia_core/sofia_core_application_shell/app_shell_index.ts || exit 1
          test -f supabase/sofia_core/sofia_core_application_shell/app_shell_context.ts || exit 1
          test -f supabase/sofia_core/sofia_core_application_shell/app_shell_lifecycle.ts || exit 1
          test -f supabase/sofia_core/sofia_core_application_shell/app_shell_manifest.json || exit 1
          test -f supabase/sofia_core/sofia_core_application_shell/README.md || exit 1
          
          # Check no nested supabase directories exist
          if find supabase/sofia_core -type d -name "supabase" | grep -q .; then
            echo "Error: Nested 'supabase' directories found"
            find supabase/sofia_core -type d -name "supabase"
            exit 1
          fi
          
          echo "✓ Directory structure validation passed"
      
      - name: Validate manifest
        run: |
          echo "Validating app_shell_manifest.json..."
          
          # Check JSON is valid using Node.js
          node -e "JSON.parse(require('fs').readFileSync('supabase/sofia_core/sofia_core_application_shell/app_shell_manifest.json', 'utf8'))"
          
          echo "✓ Manifest validation passed"
